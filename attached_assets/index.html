<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content" />
  <meta name="description" content="Portal de Login Meu Pre√ßo Certo" />
  <title>Meu Pre√ßo Certo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Estilo b√°sico para o corpo */
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      background-color: white; /* Fundo branco para combinar com o splash screen */
    }
    
    /* N√£o ocultar o root, apenas configurar a transi√ß√£o */
    #root {
      opacity: 1;
      transition: opacity 0.1s ease-in;
    }
    
    /* Inicialmente ocultamos o menu em dispositivos m√≥veis */
    @media (max-width: 768px) {
      .sidebar {
        display: none !important;
      }
      
      /* Quando o menu for aberto, esta classe ser√° adicionada pelo React */
      .sidebar.sidebar-open {
        display: block !important;
      }
      
      /* Ajustes adicionais para telas pequenas */
      body {
        font-size: 14px;
      }
      
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
    
    /* Estilo para o splash screen com fundo branco conforme solicitado */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column; /* Organiza logo e mensagem verticalmente */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.05s ease-out; /* Transi√ß√£o ainda mais r√°pida para eliminar a tela branca */
    }
    
    #splash-logo {
      height: 160px;
      width: auto;
      animation: pulse 2s infinite;
    }
    
    #splash-message {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 500;
      color: #4a5568;
      text-align: center;
      font-family: 'Inter', sans-serif;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    
    /* Estilo para anima√ß√£o de pontos de carregamento */
    .loading-dots:after {
      content: '.';
      animation: loading 1.5s infinite;
      display: inline-block;
      width: 20px;
      text-align: left;
    }
    
    @keyframes loading {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }
  </style>
</head>
<body>
  <!-- Tela de splash simples -->
  <div id="splash-screen">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <img 
        id="splash-logo" 
        src="/negativoo.png" 
        alt="Meu Pre√ßo Certo"
        onerror="this.onerror=null; this.src='/assets/negativoo.png';"
      />
      <div id="splash-message" style="margin-top: 20px; text-align: center; font-size: 18px; color: #5E35B1; font-weight: 500; opacity: 0; transition: opacity 0.5s;"></div>
      <div id="auth-redirect-message" style="margin-top: 20px; text-align: center; font-size: 16px; color: #5E35B1; font-weight: 600; opacity: 0; transition: opacity 0.5s; background-color: rgba(94, 53, 177, 0.08); padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); letter-spacing: 0.2px; min-width: 320px;"></div>
    </div>
  </div>
  
  <div id="root" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
  
  <script>
    // C√≥digo de redirecionamento simplificado apenas para p√°gina de verifica√ß√£o 2FA
    (function() {
      // Verificar se estamos na p√°gina de verifica√ß√£o 2FA
      if (window.location.pathname === '/verificar-2fa') {
        console.log("‚è© SPLASH: Detectou p√°gina de verifica√ß√£o 2FA");
        
        // Obter refer√™ncias aos elementos importantes
        const splash = document.getElementById('splash-screen');
        const authRedirectMessage = document.getElementById('auth-redirect-message');
        
        // Fun√ß√£o para verificar o status do usu√°rio e 2FA
        function verificarAutenticacao() {
          // Verificar o localStorage para dados do usu√°rio (modo simples)
          const userData = localStorage.getItem('userData');
          
          if (userData) {
            // Usu√°rio est√° logado - verificar se precisa de 2FA
            console.log("‚è© SPLASH: Usu√°rio autenticado, verificando status 2FA");
            
            // Verificar API para status de 2FA real (n√£o s√≥ o localStorage)
            // Remover o splash imediatamente para melhorar a experi√™ncia do usu√°rio
            if (splash) {
              splash.style.opacity = '0';
              splash.classList.add('loading-fast-transition');
              setTimeout(function() {
                splash.style.display = 'none';
              }, 100); // Reduzido para 100ms
            }
            
            // Fazer verifica√ß√£o em segundo plano com AbortSignal.timeout
            fetch('/api/auth/2fa-session-status?' + new Date().getTime(), {
              credentials: 'include',
              headers: {
                'Accept': 'application/json'
              },
              // Limitar tempo da requisi√ß√£o a 1.5 segundos
              signal: AbortSignal.timeout(1500)
            })
            .then(response => response.json())
            .then(data => {
              console.log("‚è© Status 2FA verificado:", data);
              
              // Verificar se o usu√°rio tem 2FA habilitado E n√£o foi verificado ainda
              if (data.twoFactorEnabled && !data.twoFactorVerified) {
                console.log("‚ö†Ô∏è 2FA precisa ser verificado - MANTENDO o usu√°rio na p√°gina de verifica√ß√£o");
                
                // Esconder mensagem de redirecionamento e deixar a p√°gina de verifica√ß√£o mostrar seus pr√≥prios elementos
                if (authRedirectMessage) {
                  authRedirectMessage.style.opacity = "0";
                }
                
                // Ocultar a tela de splash para deixar a p√°gina de verifica√ß√£o 2FA aparecer
                if (splash) {
                  splash.style.opacity = '0';
                  setTimeout(function() {
                    splash.style.display = 'none';
                  }, 100);
                }
                
                return; // Permitir que o usu√°rio veja a p√°gina de verifica√ß√£o 2FA
              }
              
              // Se 2FA j√° foi verificado ou n√£o est√° habilitado, redirecionar para dashboard
              if ((data.twoFactorVerified || !data.twoFactorEnabled) && data.authenticated) {
                // Mostrar a mensagem de usu√°rio logado
                if (authRedirectMessage) {
                  authRedirectMessage.style.opacity = "1";
                  authRedirectMessage.innerHTML = "Voc√™ j√° est√° logado!";
                  
                  // Ap√≥s 2 segundos, mudar para mensagem de redirecionamento
                  setTimeout(function() {
                    authRedirectMessage.innerHTML = "Redirecionando para sua Dashboard principal...";
                  }, 2000);
                }
                
                // Redirecionar para o dashboard ap√≥s 4 segundos
                setTimeout(function() {
                  window.location.href = "/dashboard";
                }, 4000);
              }
            })
            .catch(error => {
              console.error("Erro ao verificar status 2FA:", error);
              // Em caso de erro, mostrar a p√°gina de verifica√ß√£o 2FA normal
              if (splash) {
                splash.style.opacity = '0';
                setTimeout(function() {
                  splash.style.display = 'none';
                }, 100); // Tempo reduzido para acelerar a transi√ß√£o em caso de erro
              }
            });
          } else {
            // Usu√°rio N√ÉO est√° logado - mostrar mensagem e redirecionar para login
            console.log("‚è© SPLASH: Usu√°rio N√ÉO autenticado, redirecionando para login");
            
            // Mostrar a mensagem de usu√°rio n√£o logado
            if (authRedirectMessage) {
              authRedirectMessage.style.opacity = "1";
              authRedirectMessage.innerHTML = "Voc√™ n√£o est√° logado!";
              
              // Ap√≥s 2 segundos, mudar para mensagem de redirecionamento
              setTimeout(function() {
                authRedirectMessage.innerHTML = "Redirecionando para tela de login...";
              }, 2000);
            }
            
            // Redirecionar para o login ap√≥s 4 segundos
            setTimeout(function() {
              window.location.href = "/acessar";
            }, 4000);
          }
        }
        
        // Executar verifica√ß√£o imediatamente sem delay
        verificarAutenticacao();
        
        // N√£o executar o resto do c√≥digo para evitar duplo processamento
        return;
      }
    })();
    
    // Script otimizado para gerenciar o splash screen e melhorar carregamento
    // Captura o tempo inicial do carregamento da p√°gina
    const pageLoadStartTime = performance.now();
    
    document.addEventListener('DOMContentLoaded', function() {
      // Registrar o tempo do DOMContentLoaded
      const domLoadTime = performance.now();
      console.log(`[‚è±Ô∏è Performance] DOMContentLoaded: ${(domLoadTime - pageLoadStartTime).toFixed(2)}ms`);
      
      const splash = document.getElementById('splash-screen');
      const authRedirectMessage = document.getElementById('auth-redirect-message');
      let splashTimeout;
      let splashShownDuration;
      const splashStartTime = pageLoadStartTime; // Tempo em que o splash come√ßou a ser exibido
      
      // Verificar se o usu√°rio est√° autenticado
      function checkUserAuthentication() {
        try {
          // Verificar se h√° dados do usu√°rio no localStorage
          const userData = localStorage.getItem('userData');
          
          // Verificar se estamos na landing page (raiz)
          const isLandingPage = window.location.pathname === '/' || window.location.pathname === '';
          
          if (userData) {
            // Usu√°rio autenticado
            
            // N√ÉO mostrar a mensagem de redirecionamento nas p√°ginas normais, 
            // pois a verifica√ß√£o 2FA tem seu pr√≥prio c√≥digo no in√≠cio do script
            const isVerify2FARoute = window.location.pathname === '/verificar-2fa';
            
            // Se N√ÉO for a p√°gina de verifica√ß√£o 2FA, n√£o mostramos mensagem
            if (!isVerify2FARoute && !isLandingPage && authRedirectMessage) {
              authRedirectMessage.innerHTML = ""; 
              authRedirectMessage.style.opacity = "0";
              console.log("Usu√°rio autenticado em p√°gina normal");
            } else if (isLandingPage) {
              console.log("Usu√°rio autenticado na landing page - n√£o mostrando mensagem");
            }
            
            return true;
          }
        } catch (e) {
          console.error("Erro ao verificar autentica√ß√£o:", e);
        }
        return false;
      }
      
      // Verificar autentica√ß√£o no carregamento da p√°gina
      checkUserAuthentication();
      
      // REMOVIDA a fun√ß√£o check2FAStatus - agora a verifica√ß√£o √© feita diretamente no in√≠cio do script
      
      // A verifica√ß√£o 2FA agora √© feita diretamente no in√≠cio do script
      
      // Fun√ß√£o para esconder o splash
      function hideSplash() {
        if (splash) {
          // Verificar se estamos na p√°gina de verifica√ß√£o 2FA e exibindo mensagens
          const isVerify2FARoute = window.location.pathname === '/verificar-2fa';
          const authRedirectMessage = document.getElementById('auth-redirect-message');
          
          // Se estiver na p√°gina de verifica√ß√£o 2FA, N√ÉO remover o splash at√© o redirecionamento completo
          if (isVerify2FARoute && authRedirectMessage && authRedirectMessage.style.opacity === '1') {
            console.log(`[‚è±Ô∏è Performance] Mantendo splash screen para p√°gina de verifica√ß√£o 2FA`);
            return; // N√£o remover o splash ainda - esperando pelo redirecionamento autom√°tico
          }
          
          const splashHideTime = performance.now();
          splashShownDuration = splashHideTime - splashStartTime;
          
          console.log(`[‚è±Ô∏è Performance] Splash screen exibido por: ${splashShownDuration.toFixed(2)}ms`);
          
          // Transi√ß√£o r√°pida do splash screen para evitar tela branca intermedi√°ria
          splash.style.opacity = '0';
          
          // Tempo de transi√ß√£o m√≠nimo para evitar a tela branca intermedi√°ria
          setTimeout(function() {
            splash.style.display = 'none';
            console.log(`[‚è±Ô∏è Performance] Splash screen completamente removido em: ${(performance.now() - splashHideTime).toFixed(2)}ms`);
          }, 100);
        }
      }
      
      // Nova estrat√©gia para evitar a tela branca: manter o splash at√© que o conte√∫do esteja pronto
      // e s√≥ ent√£o fazer a transi√ß√£o
      function checkContent() {
        const root = document.getElementById('root');
        
        if (root && root.children.length > 0) {
          // Procurar por elementos importantes que indicam que a p√°gina est√° pronta
          const header = root.querySelector('header');
          const firstSection = root.querySelector('section') || root.querySelector('[id^="home"]') || root.querySelector('.hero');
          
          // Se encontrou pelo menos um desses elementos, o conte√∫do est√° come√ßando a aparecer
          if (header || firstSection) {
            const contentTime = performance.now();
            console.log(`[‚è±Ô∏è Performance] Conte√∫do detectado ap√≥s: ${(contentTime - pageLoadStartTime).toFixed(2)}ms`);
            console.log(`[‚è±Ô∏è Performance] Elementos chave carregados: ${header ? 'header ' : ''}${firstSection ? 'primeira se√ß√£o' : ''}`);
            
            // Conte√∫do j√° est√° vis√≠vel, removemos o splash imediatamente
            console.log("[‚è±Ô∏è Performance] Conte√∫do vis√≠vel, iniciando remo√ß√£o do splash");
            hideSplash();
            
            return true;
          }
          
          // Verifica√ß√£o alternativa baseada em elementos vis√≠veis
          const visibleElements = root.querySelectorAll('div:not([style*="display:none"]):not([style*="display: none"]):not([style*="visibility:hidden"]):not([style*="visibility: hidden"])');
          
          if (visibleElements.length > 1) {
            const contentTime = performance.now();
            console.log(`[‚è±Ô∏è Performance] Elementos vis√≠veis detectados ap√≥s: ${(contentTime - pageLoadStartTime).toFixed(2)}ms`);
            console.log(`[‚è±Ô∏è Performance] Total de elementos vis√≠veis: ${visibleElements.length}`);
            
            // Removemos o splash imediatamente
            console.log("[‚è±Ô∏è Performance] Conte√∫do vis√≠vel, iniciando remo√ß√£o do splash");
            hideSplash();
            
            return true;
          }
        }
        return false;
      }
      
      // Verificar a cada 25ms se o conte√∫do existe (frequ√™ncia ainda mais aumentada para transi√ß√£o mais r√°pida)
      const contentCheckInterval = setInterval(function() {
        if (checkContent()) {
          clearInterval(contentCheckInterval);
        }
      }, 25);
      
      // Expor fun√ß√£o de esconder splash no escopo global para que as p√°ginas possam acess√°-la
      window.hideSplashScreen = hideSplash;
      
      // SOLU√á√ÉO DIRETA: Como estamos tendo problemas espec√≠ficos com o 2FA,
      // vamos usar um timeout muito mais agressivo e corrigir de uma vez
      const is2FAVerifyPage = window.location.pathname === '/verificar-2fa';
      const is2FALoginPage = window.location.pathname === '/acessar' && localStorage.getItem('pendingTwoFactor') === 'true';
      
      // Se √© uma p√°gina de 2FA em qualquer forma, o timeout √© extremamente r√°pido (100ms)
      // para outras p√°ginas, usamos 800ms para garantir remo√ß√£o da splash em todos os casos
      const timeoutDuration = (is2FAVerifyPage || is2FALoginPage) ? 100 : 800;
      
      // SUPER IMPORTANTE: TIMEOUT EXTRA para garantir que o splash sempre ser√° removido
      setTimeout(function() {
        console.log("üö® TIMEOUT ABSOLUTO: For√ßando remo√ß√£o do splash screen ap√≥s 1.5s");
        if (splash) {
          splash.style.opacity = '0';
          setTimeout(function() {
            splash.style.display = 'none';
          }, 10);
        }
      }, 1500); // Este √© um timeout de seguran√ßa final que sempre ser√° executado
      
      splashTimeout = setTimeout(function() {
        console.log(`[‚è±Ô∏è Performance] Timeout de seguran√ßa atingido ap√≥s: ${(performance.now() - pageLoadStartTime).toFixed(2)}ms`);
        console.log("Timeout de seguran√ßa atingido, removendo splash");
        
        // Na p√°gina de verifica√ß√£o 2FA, for√ßar a remo√ß√£o do splash imediatamente 
        const is2FAVerifyPage = window.location.pathname === '/verificar-2fa';
        if (is2FAVerifyPage) {
          if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => {
              splash.style.display = 'none';
            }, 10);
          }
          return;
        }
        
        // Verificar se o usu√°rio est√° autenticado (para n√£o cortar a mensagem de redirecionamento muito cedo)
        const isAuthenticated = checkUserAuthentication();
        
        // Verificar uma √∫ltima vez se h√° conte√∫do antes de for√ßar a remo√ß√£o do splash
        if (!checkContent() && !isAuthenticated) {
          console.log("[‚è±Ô∏è Performance] Removendo splash por timeout, conte√∫do ainda n√£o detectado");
          hideSplash();
        }
        
        clearInterval(contentCheckInterval);
      }, 8000);
    });
    
    // Adicionar evento de load para capturar tempo total de carregamento
    window.addEventListener('load', function() {
      const loadTime = performance.now();
      console.log(`[‚è±Ô∏è Performance] Window.load (total): ${(loadTime - pageLoadStartTime).toFixed(2)}ms`);
      
      // Relatar as m√©tricas de navega√ß√£o
      if (performance.getEntriesByType && typeof performance.getEntriesByType === 'function') {
        setTimeout(function() {
          try {
            const navigationEntries = performance.getEntriesByType('navigation');
            if (navigationEntries && navigationEntries.length > 0) {
              const navEntry = navigationEntries[0];
              console.log(`[‚è±Ô∏è Performance] M√©tricas de navega√ß√£o:`, navEntry);
            }
            
            // Listar as m√©tricas de recursos (10 mais lentos)
            const resourceEntries = performance.getEntriesByType('resource')
              .sort((a, b) => b.duration - a.duration)
              .slice(0, 10);
            
            console.log(`[‚è±Ô∏è Performance] 10 recursos mais lentos:`, resourceEntries);
          } catch (e) {
            console.warn("Erro ao coletar m√©tricas de performance:", e);
          }
        }, 1000);
      }
    });
  </script>
  
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>